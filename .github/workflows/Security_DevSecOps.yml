name: DevSecOps

on:
  pull_request:
    types: ['opened', 'edited', 'reopened', 'synchronize', 'ready_for_review']


jobs:

  changelog:

    if: (! github.event.pull_request.draft) && github.head_ref != 'develop'

    defaults:
      run:
        shell: bash

    name: ChangeLOG
    runs-on: ubuntu-latest

    steps:

      - name: Checkout
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: ChangeLOG
        if: ${{ github.head_ref != 'develop' }}
        run:  |
          FILE=$(git diff --name-only origin/develop...HEAD | grep -E 'CHANGELOG\.md' -c)
          if [[ $FILE == "1" ]];
          then
            echo ""
            cat ./changelog/sucesso
            exit 0
          else
            echo ""
            cat ./changelog/negativo
            echo ""
            echo "---------------------------------------------------------------------------"
            echo "-----------------------------Add Changelog!!!------------------------------"
          fi;
          
  TruffleHog:
    runs-on: ubuntu-latest
    needs: changelog
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 1000
      - name: TruffleHog OSS
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          base: develop
          head: HEAD
          extra_args: --debug --only-verified


  GitGuardian-scan:
    name: GitGuardian scan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v2
        with:
          fetch-depth: 50 # fetch all history so multiple commits can be scanned
      - name: GitGuardian scan
        uses: GitGuardian/ggshield-action@master
        env:
          GITHUB_PUSH_BEFORE_SHA: ${{ github.event.before }}
          GITHUB_PUSH_BASE_SHA: ${{ github.event.base }}
          GITHUB_PULL_BASE_SHA:  ${{ github.event.pull_request.base.sha }}
          GITHUB_DEFAULT_BRANCH: ${{ github.event.repository.default_branch }}
          GITGUARDIAN_API_KEY: ${{ secrets.GITGUARDIAN_API_KEY }}
  
  scan:
    name: gitleaks
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 50
      - uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.MAIN_GITHUB_TOKEN }}
          